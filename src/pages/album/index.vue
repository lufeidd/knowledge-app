<template>
  <div id="albumPage" class="page">
    <div class="nullBox" v-if="onsale == 0">
      <img src="./../../assets/null/product.png" width="100%" />
      <div>该商品已下架~</div>
    </div>

    <div v-if="onsale == 1">
      <!-- 基础信息 -->
      <div class="listBox">
        <div class="left">
          <div class="ratioBox">
            <div class="box">
              <img :src="baseData.pic[0]" />
            </div>
          </div>
        </div>
        <div class="center" style="display: block;">
          <div class="title">
            <div class="text">{{ baseData.title }}</div>
            <div
              class="action"
              @click="collectAction('base', baseData.collect_id, baseData.goods_id)"
            >
              <van-tag round color="#fff" text-color="#f05654">
                <svg class="icon" aria-hidden="true" v-if="baseData.collect_id > 0">
                  <use xlink:href="#icon-collect-block" />
                </svg>
                <svg class="icon" aria-hidden="true" v-else>
                  <use xlink:href="#icon-collect-line" />
                </svg>
                <span>
                  <template v-if="baseData.collect_id > 0">已</template>收藏
                </span>
              </van-tag>
            </div>
          </div>
          <div class="subTitle" style="height: auto;">{{ baseData.sub_title }}</div>
          <div class="info">
            <router-link
              :to="{name: 'brand', query: {brand_id: brandInfoData.brand_id}}"
              class="name"
            >
              <van-tag round color="rgba(0,0,0,.12)" text-color="#fff">
                <img :src="brandInfoData.header_pic" width="15" height="15" />
                {{ brandInfoData.name }}
              </van-tag>
            </router-link>
            <div class="count">
              <van-tag
                round
                color="rgba(0,0,0,.12)"
                text-color="#fff"
              >{{ baseData.collection_num }}收藏</van-tag>
            </div>
          </div>
        </div>
      </div>

      <!-- 介绍 - 节目 - 相似 -->
      <van-tabs v-model="tabModel" sticky animated @click="tabChange">
        <van-tab v-for="(item, key) in tabData" :title="item.title" :key="key">
          <template v-if="activeKey == key">
            <!-- 介绍 -->
            <div class="infoContent" v-if="key == 0">
              <!-- 介绍 -->
              <div
                class="htmlContent"
                v-html="baseData.desc"
                style="background-color: #fff;padding: 10px;"
              >{{ baseData.desc }}</div>
              <!-- 关注公众号 -->
              <div class="publish">
                <router-link
                  :to="{name: 'brand', query: {brand_id: brandInfoData.brand_id}}"
                  class="from"
                >
                  <div class="icon">
                    <img v-lazy="brandInfoData.header_pic" />
                  </div>

                  <div class="publishInfo">
                    <p class="publishName">{{ brandInfoData.name }}</p>
                    <p class="focusNumber">已有{{ brandInfoData.fans }}人关注</p>
                  </div>
                </router-link>
                <span
                  class="focus add"
                  v-if="brandInfoData.is_followed == 0"
                  @click="focusAction"
                >+关注</span>
                <span class="focus" v-else @click="focusAction">已关注</span>
              </div>
              <!-- 评论 -->
              <div class="commentBox">
                <van-cell
                  :title="totalCount"
                  is-link
                  value="我要评论"
                  @click="openAnswer('comment', null)"
                />

                <van-list
                  v-model="commentLoading"
                  :finished="commentFinished"
                  finished-text="没有更多了"
                  @load="commentLoad"
                >
                  <div class="listBox" v-for="(item, key) in discussData" :key="key">
                    <div class="left">
                      <div class="ratioBox">
                        <div class="box">
                          <img :src="item.user_header" />
                        </div>
                      </div>
                    </div>
                    <div class="center">
                      <div class="title">
                        <div class="text">{{ item.nick_name }}</div>
                      </div>
                      <div class="subTitle" style="height: auto;">{{ item.content }}</div>

                      <div class="messageBox" v-if="answerData[key].length > 0">
                        <!-- 回复 -->

                        <!-- <div
                          class="message active"
                          v-for="(replyItem, key) in item.reply_list"
                          :key="key"
                        >
                          <span class="name">{{ replyItem.nick_name }}</span>
                          <span class="dialog">{{ replyItem.content }}</span>
                        </div>-->

                        <div
                          class="message active"
                          v-for="(replyItem, key) in answerData[key]"
                          :key="key"
                        >
                          <span class="name">{{ replyItem.nick_name }}</span>
                          <span class="dialog">{{ replyItem.content }}</span>
                        </div>

                        <div
                          class="message active"
                          v-if="item.reply_num > 2 && replyPage[key] <= item.reply_total_page"
                        >
                          <!-- <van-pagination v-model="item.reply_current_page" :page-count="item.reply_total_page" mode="simple" @change="pageChange(item.comment_id, key)" /> -->

                          <span class="name" @click="pageChange(item.comment_id, key)">
                            共{{ item.reply_num }}条回复
                            <svg class="icon" aria-hidden="true">
                              <use xlink:href="#icon-fold-line" />
                            </svg>
                            <!-- <svg class="icon" aria-hidden="true">
                              <use xlink:href="#icon-unfold-line"></use>
                            </svg>-->
                          </span>
                        </div>
                      </div>

                      <!-- 回复 -->
                      <div class="answerBox">
                        <span class="date">{{ item.create_time }}</span>
                        <span class="action" @click="openAnswer('reply', item.comment_id)">回复</span>
                      </div>
                    </div>
                  </div>
                </van-list>
              </div>
            </div>
            <!-- 节目 -->
            <van-list
              v-if="key == 1"
              v-model="programLoading"
              :finished="programFinished"
              finished-text="没有更多了"
              @load="programLoad"
            >
              <div class="listContent">
                <van-row class="title">
                  <van-col span="12">
                    <span class="play">
                      <van-tag
                        v-if="allPlayStatus == 'play'"
                        color="#f5f5f5"
                        text-color="#666"
                        @click="allAction"
                      >
                        <van-icon name="play" />全部播放
                      </van-tag>
                      <van-tag
                        v-if="allPlayStatus == 'pause'"
                        color="#f5f5f5"
                        text-color="#666"
                        @click="allAction"
                      >
                        <van-icon name="pause" />暂停播放
                      </van-tag>
                      <van-tag
                        v-if="allPlayStatus == 'continue'"
                        color="#f5f5f5"
                        text-color="#666"
                        @click="allAction"
                      >
                        <van-icon name="play" />继续播放
                      </van-tag>

                      <span class="tag" v-if="showHistory && myAudioData.src">
                        <span class="text">{{ myAudioData.program }}</span>
                        <svg class="icon" aria-hidden="true" @click="historyAction">
                          <use xlink:href="#icon-close-line" />
                        </svg>
                      </span>
                    </span>
                    <span class="total">共{{ programTotalCount }}集</span>
                  </van-col>
                  <van-col span="12" style="text-align:right;">
                    <svg class="icon" aria-hidden="true" v-if="rankType == 0" @click="rankAction">
                      <use xlink:href="#icon-reverse-line" />
                    </svg>
                    <svg class="icon" aria-hidden="true" v-if="rankType == 1" @click="rankAction">
                      <use xlink:href="#icon-upright-line" />
                    </svg>
                  </van-col>
                </van-row>

                <div class="content" v-for="(item, key) in programList" :key="key">
                  <van-row class="list">
                    <van-col span="2" class="rank">{{ item.goods_no }}</van-col>
                    <van-col span="16">
                      <div class="desc" @click="gotoDetail(item)">
                        <template v-if="item.goods_type != 6">
                          <span class="tag" v-if="item.is_free == 1 && item.is_payed != 1">免费</span>
                          <span class="tag" v-if="item.is_payed == 1">已购</span>
                        </template>
                        {{ item.title }}
                      </div>
                      <div class="info" @click="gotoDetail(item)">
                        <template v-if="item.goods_type == 1">
                          <van-tag color="#c8c8c8" text-color="#fff">音频</van-tag>
                          <span class="count">
                            <svg class="icon" aria-hidden="true">
                              <use xlink:href="#icon-audio-line" />
                            </svg>
                            {{ item.play_num }}
                          </span>
                        </template>
                        <template v-if="item.goods_type == 2">
                          <van-tag color="#c8c8c8" text-color="#fff">视频</van-tag>
                          <span class="count">
                            <svg class="icon" aria-hidden="true">
                              <use xlink:href="#icon-video-line" />
                            </svg>
                            {{ item.play_num }}
                          </span>
                        </template>
                        <template v-if="item.goods_type == 6">
                          <van-tag color="#c8c8c8" text-color="#fff">文章</van-tag>
                          <span class="count">
                            <svg class="icon" aria-hidden="true">
                              <use xlink:href="#icon-list-line" />
                            </svg>
                            {{ item.play_num }}
                          </span>
                        </template>

                        <span class="time" v-if="item.goods_type != 6">
                          <svg class="icon" aria-hidden="true">
                            <use xlink:href="#icon-time-line" />
                          </svg>
                          {{ item.duration }}
                        </span>

                        <template v-if="progressList.length > 0">
                          <span
                            class="history"
                            v-if="item.goods_type != 6 && progressList[key].progressHistory"
                          >已播{{ (progressList[key].progressHistory / progressList[key].ori_duration * 100).toFixed(2) }}%</span>
                        </template>
                      </div>
                    </van-col>
                    <van-col span="6" style="text-align:right;align-self:flex-start;">
                      <div class="date">{{ item.create_time }}</div>
                      <div class="status" v-if="item.goods_type == 1" @click="audioAction(item)">
                        <svg
                          class="icon"
                          aria-hidden="true"
                          v-if="item.goods_no == activeGoodNo && audioPlaying"
                        >
                          <use xlink:href="#icon-pause-line" />
                        </svg>
                        <svg class="icon" aria-hidden="true" v-else>
                          <use xlink:href="#icon-play-line" />
                        </svg>
                      </div>
                    </van-col>
                  </van-row>
                </div>
              </div>
            </van-list>
            <!-- 相似 -->
            <van-list
              v-if="key == 2"
              v-model="recommendLoading"
              :finished="recommendFinished"
              finished-text="没有更多了"
              @load="recommendLoad"
            >
              <div class="simularContent">
                <div class="listBox" v-for="(item, key) in recommendList" :key="key">
                  <div class="left">
                    <div class="ratioBox">
                      <div class="box">
                        <img :src="item.pic[0]" />
                      </div>
                    </div>
                  </div>
                  <div class="center">
                    <div class="title">
                      <!-- 专辑推荐的一定是专辑，goods_type: 9 -->
                      <div @click="gotoLink(item.goods_id)" class="text">{{ item.title }}</div>

                      <div
                        class="action"
                        @click="collectAction(key, simularStatus[key].is_collect, item.goods_id)"
                        style="border: 1px #ccc solid;"
                      >
                        <van-tag
                          style="position: relative; top: -7px;z-index: 1;border: none;"
                          plain
                          round
                          color="#fff"
                          text-color="#f05654"
                          type="danger"
                        >
                          <svg
                            class="icon"
                            aria-hidden="true"
                            v-if="simularStatus[key].is_collect == 1"
                          >
                            <use xlink:href="#icon-collect-block" />
                          </svg>
                          <svg
                            class="icon"
                            aria-hidden="true"
                            v-if="simularStatus[key].is_collect == 0"
                          >
                            <use xlink:href="#icon-collect-line" />
                          </svg>
                          <span>
                            <template v-if="simularStatus[key].is_collect == 1">已</template>收藏
                          </span>
                        </van-tag>
                      </div>
                    </div>
                    <div class="subTitle">{{ item.sub_title }}</div>
                    <div class="info">
                      <template v-if="item.goods_type == 1">
                        <van-tag color="#c8c8c8" text-color="#fff">音频</van-tag>
                        <span class="count">
                          <svg class="icon" aria-hidden="true">
                            <use xlink:href="#icon-audio-line" />
                          </svg>
                          {{ item.play_num }}
                        </span>
                      </template>
                      <template v-if="item.goods_type == 2">
                        <van-tag color="#c8c8c8" text-color="#fff">视频</van-tag>
                        <span class="count">
                          <svg class="icon" aria-hidden="true">
                            <use xlink:href="#icon-video-line" />
                          </svg>
                          {{ item.play_num }}
                        </span>
                      </template>
                      <span class="time">
                        <svg class="icon" aria-hidden="true">
                          <use xlink:href="#icon-eye-line" />
                        </svg>
                        {{ item.play_num }}
                        共{{ item.item_count }}集
                      </span>
                      <!-- <span class="history"></span> -->
                    </div>
                  </div>
                </div>
              </div>
            </van-list>
          </template>
        </van-tab>
      </van-tabs>

      <div
        style="height: 60px;"
        v-if="baseData.is_free == 0 && baseData.is_payed == 0 && baseData.sale_style == 1"
      ></div>
      <!-- <div v-if=" myAudioData.src" style="height: 60px;"></div> -->
      <div v-if="this.isIphx" style="height: 34px;"></div>

      <!-- 优惠券 -->
      <div
        class="coupon"
        :class="{ iphx: this.isIphx }"
        v-if="Object.keys(couponInfo.ticket).length>0 && (baseData.is_free == 0 && baseData.is_payed == 0 && baseData.sale_style == 1)"
      >
        <van-cell title is-link value @click="showCoupon">
          <template slot="title">
            <span style="margin-right:10px;" v-if="isReceived">已领券</span>
            <span style="margin-right:10px;" v-else>领券</span>
            <span
              class="toMall"
              v-for="(item,index) in couponInfo.ticket.list"
              :key="index"
            >{{item}}</span>
          </template>
        </van-cell>
      </div>
      <div
        class="coupon bottom"
        :class="{ iphx: this.isIphx }"
        v-if="Object.keys(couponInfo.ticket).length>0 && (baseData.is_free == 1 || baseData.is_payed == 1 || baseData.sale_style == 0)"
      >
        <van-cell title is-link value @click="showCoupon">
          <template slot="title">
            <span style="margin-right:10px;" v-if="isReceived">已领券</span>
            <span style="margin-right:10px;" v-else>领券</span>
            <span
              class="toMall"
              v-for="(item,index) in couponInfo.ticket.list"
              :key="index"
            >{{item}}</span>
          </template>
        </van-cell>
      </div>
      <!-- 试听 - 购买 -->
      <van-goods-action
        :class="{ iphx: this.isIphx }"
        v-if="baseData.is_free == 0 && baseData.is_payed == 0 && baseData.sale_style == 1 && (couponInfo.groupbuy == undefined || Object.keys(couponInfo.groupbuy).length == 0)"
      >
        <van-goods-action-mini-btn
          icon="play-circle-o"
          text="试听"
          @click="preListenAction"
          v-if="baseData.has_free && preListen"
        />
        <van-goods-action-big-btn
          primary
          :text="'¥ '+baseData.price.toFixed(2) + ' 购买'"
          @click="buyAction(baseData.goods_id)"
        />
      </van-goods-action>
      <van-goods-action
        :class="{ iphx: this.isIphx }"
        v-if="baseData.is_free == 0 && baseData.is_payed == 0 && baseData.sale_style == 1 && couponInfo.groupbuy && Object.keys(couponInfo.groupbuy).length > 0"
      >
        <van-goods-action-mini-btn
          icon="play-circle-o"
          text="试听"
          @click="preListenAction"
          v-if="baseData.has_free && preListen"
        />
        <van-goods-action-big-btn
          :text="'¥ '+baseData.price + ' 购买'"
          @click="buyAction(baseData.goods_id)"
        />
        <van-goods-action-big-btn
          primary
          :text="'¥ '+couponInfo.groupbuy.groupbuy_price + ' 拼团'"
          @click="openGroup"
        />
      </van-goods-action>

      <!-- 音频缩略 -->
      <miniAudio
        :class="{isShow: myAudioData.src}"
        :audioData="myAudioData"
        :rank="rankType"
        :loginStatus="isLogin"
        :showBuyButton="showBuyButton"
        :baseData="baseData"
        ref="control"
        @setType="typeAction"
        @setMiniAudio="miniAudioData"
        @setProgress="audioProgressData"
        @showAudioList="audioListShow"
        @linkToPlayer="gotoPlayer"
        @getAllProgram="getAllProgramData"
      ></miniAudio>

      <!-- 播放列表 -->
      <audioList
        :goodsId="baseData.goods_id"
        :albumInfo="baseData"
        :goodsNo="activeGoodNo"
        :audioStatus="audioPlaying"
        @audioChange="audioAction"
        @progressListData="progressListData"
        ref="controlList"
      ></audioList>
      <!-- 领取优惠券 -->
      <van-popup v-model="couponModel" position="bottom" style="max-height:65%;min-height:65%;">
        <div class="header">
          <span class="catalogWord">可用优惠券（满足条件后可用于当前商品）</span>
          <span>
            <svg class="icon" aria-hidden="true" @click="closePopup">
              <use xlink:href="#icon-close-line" />
            </svg>
          </span>
        </div>
        <div class="content">
          <div
            style="margin-top:10px;overflow:hidden;border-radius:0 6px 6px 0;box-shadow:0 0 10px rgba(0,0,0,0.06);"
            v-for="(item,index) in couponList"
            :key="index"
          >
            <!-- 可领取 -->
            <div class="toUse" v-if="item.state == 1 || item.state == 3">
              <div class="left"></div>
              <div class="mid">
                <div>
                  ￥
                  <span class="price">{{item.money}}</span>
                </div>
                <div class="condition">{{item.use_time_desc}}</div>
                <span class="circle top"></span>
                <span class="circle bottom"></span>
              </div>
              <div class="right">
                <div>
                  <span class="shopCoupon">
                    <svg class="icon" aria-hidden="true">
                      <use xlink:href="#icon-coupon-block" />
                    </svg>
                    <span class="dianpu" v-if="item.brand_id">店铺券</span>
                    <span class="dianpu" v-else>平台券</span>
                  </span>
                  <span class="shop">{{item.brand_name}}</span>
                </div>
                <div class="desc">
                  {{item.use_range_desc}}
                  <span
                    class="toMall btn red"
                    v-if="item.state == 1 && requestState"
                    @click="receive(item,index)"
                  >点击领取</span>
                  <span class="toMall btn red" v-if="item.state == 1 && !requestState">点击领取</span>
                  <span class="toMall btn" v-if="item.state == 3" @click="toResult(item,index)">可用商品</span>
                </div>
                <div class="time">
                  <span
                    v-if="item.state == 3"
                  >{{item.use_stime.replace(/-/g,'.').substring(0,10)}}-{{item.use_etime.replace(/-/g,'.').substring(0,10)}}</span>
                  <span v-else>
                    <span v-if="item.use_time_type == 2">领取后{{item.use_time_day}}天有效</span>
                    <span
                      v-else
                    >{{item.use_stime.replace(/-/g,'.').substring(0,10)}}-{{item.use_etime.replace(/-/g,'.').substring(0,10)}}</span>
                  </span>
                </div>
                <span class="used" v-if="item.state == 3">
                  <svg class="icon" aria-hidden="true">
                    <use xlink:href="#icon-yilingqu" />
                  </svg>
                </span>
              </div>
            </div>
            <!-- 已领完 -->
            <div class="toUse overdue" v-if="item.state == 2">
              <div class="left"></div>
              <div class="mid">
                <div>
                  ￥
                  <span class="price">{{item.money}}</span>
                </div>
                <div class="condition">{{item.use_time_desc}}</div>
                <span class="circle top"></span>
                <span class="circle bottom"></span>
              </div>
              <div class="right">
                <div>
                  <span class="shopCoupon">
                    <svg class="icon" aria-hidden="true">
                      <use xlink:href="#icon-coupon-block" />
                    </svg>
                    <span class="dianpu" v-if="item.brand_id">店铺券</span>
                    <span class="dianpu" v-else>平台券</span>
                  </span>
                  <span class="shop">{{item.brand_name}}</span>
                </div>
                <div class="desc">{{item.use_range_desc}}</div>
                <span class="used">
                  <svg class="icon" aria-hidden="true">
                    <use xlink:href="#icon-received-line" />
                  </svg>
                </span>
                <div class="time" v-if="item.use_time_type == 2">领取后{{item.use_time_day}}天有效</div>
                <div
                  class="time"
                  v-else
                >{{item.use_stime.replace(/-/g,'.').substring(0,10)}}-{{item.use_etime.replace(/-/g,'.').substring(0,10)}}</div>
              </div>
            </div>
          </div>
        </div>
      </van-popup>
      <!-- 拼团 -->
      <van-popup
        v-model="groupModel"
        v-if="couponInfo.groupbuy && Object.keys(couponInfo.groupbuy).length > 0"
        style="width:95%;height:60%;border-radius:6px;"
      >
        <div class="group">
          <div class="top">
            <div class="ratiobox">
              <div class="bookImg" :style="{'background-image':'url('+baseData.pic[0]+')'}"></div>
            </div>
            <div class="right">
              <div class="title">{{baseData.title}}</div>
              <div class="sign">
                <svg class="icon" aria-hidden="true">
                  <use xlink:href="#icon-huo" />
                </svg>
                {{couponInfo.groupbuy.join_desc}}
              </div>
              <div
                class="desc"
              >{{couponInfo.groupbuy.groupbuy_num}}人团：￥{{couponInfo.groupbuy.groupbuy_price.toFixed(2)}}</div>
            </div>
          </div>
          <div class="list" v-if="couponInfo.groupbuy.open_list.length>0">
            <div class="content" v-for="(item,index) in couponInfo.groupbuy.open_list" :key="index">
              <!-- 2人团 -->
              <div class="left" v-if="item.nums == 2">
                <img
                  :src="item.user_head_list[0]"
                  width="30px"
                  height="30px"
                  alt
                  style="left:0;z-index:1;"
                />
                <span class="add" style="left:50px;z-index:4;">
                  <svg class="icon" aria-hidden="true">
                    <use xlink:href="#icon-renshu" />
                  </svg>
                </span>
              </div>
              <!-- 三人团剩2人 -->
              <div class="left" v-if="item.nums == 3">
                <img
                  :src="item.user_head_list[0]"
                  width="30px"
                  height="30px"
                  alt
                  style="left:0;z-index:1;"
                />
                <span class="add" style="left:30px;z-index:3;">
                  <svg class="icon" aria-hidden="true">
                    <use xlink:href="#icon-renshu" />
                  </svg>
                </span>
                <span class="add" style="left:50px;z-index:4;">
                  <svg class="icon" aria-hidden="true">
                    <use xlink:href="#icon-renshu" />
                  </svg>
                </span>
              </div>
              <!-- 三人团剩1人 -->
              <div class="left" v-if="item.nums == 3">
                <img
                  :src="item.user_head_list[0]"
                  width="30px"
                  height="30px"
                  alt
                  style="left:0;z-index:1;"
                />
                <img
                  :src="item.user_head_list[1]"
                  width="30px"
                  height="30px"
                  alt
                  style="left:25px;z-index:3;"
                />
                <span class="add" style="left:50px;z-index:4;">
                  <svg class="icon" aria-hidden="true">
                    <use xlink:href="#icon-renshu" />
                  </svg>
                </span>
              </div>
              <!-- 三人团剩1人 -->
              <div class="left" v-if="item.nums == 3">
                <img
                  :src="item.user_head_list[0]"
                  width="30px"
                  height="30px"
                  alt
                  style="left:0;z-index:1;"
                />
                <img
                  :src="item.user_head_list[1]"
                  width="30px"
                  height="30px"
                  alt
                  style="left:25px;z-index:3;"
                />
                <span class="add" style="left:50px;z-index:4;">
                  <svg class="icon" aria-hidden="true">
                    <use xlink:href="#icon-renshu" />
                  </svg>
                </span>
              </div>
              <!-- 四人团剩3人 -->
              <div class="left" v-if="item.nums == 4">
                <img
                  :src="item.user_head_list[0]"
                  width="30px"
                  height="30px"
                  alt
                  style="left:0;z-index:1;"
                />
                <span class="add" style="left:15px;z-index:2;">
                  <svg class="icon" aria-hidden="true">
                    <use xlink:href="#icon-renshu" />
                  </svg>
                </span>
                <span class="add" style="left:30px;z-index:3;">
                  <svg class="icon" aria-hidden="true">
                    <use xlink:href="#icon-renshu" />
                  </svg>
                </span>
                <span class="add" style="left:50px;z-index:4;">
                  <svg class="icon" aria-hidden="true">
                    <use xlink:href="#icon-renshu" />
                  </svg>
                </span>
              </div>
              <!-- 四人团剩2人 -->
              <div class="left" v-if="item.nums == 4">
                <img
                  :src="item.user_head_list[0]"
                  width="30px"
                  height="30px"
                  alt
                  style="left:0;z-index:1;"
                />
                <img
                  :src="item.user_head_list[1]"
                  width="30px"
                  height="30px"
                  alt
                  style="left:15px;z-index:2;"
                />
                <span class="add" style="left:30px;z-index:3;">
                  <svg class="icon" aria-hidden="true">
                    <use xlink:href="#icon-renshu" />
                  </svg>
                </span>
                <span class="add" style="left:50px;z-index:4;">
                  <svg class="icon" aria-hidden="true">
                    <use xlink:href="#icon-renshu" />
                  </svg>
                </span>
              </div>
              <!-- 四人团剩1人 -->
              <div class="left" v-if="item.nums == 4">
                <img
                  :src="item.user_head_list[0]"
                  width="30px"
                  height="30px"
                  alt
                  style="left:0;z-index:1;"
                />
                <img
                  :src="item.user_head_list[1]"
                  width="30px"
                  height="30px"
                  alt
                  style="left:15px;z-index:2;"
                />
                <img
                  :src="item.user_head_list[2]"
                  width="30px"
                  height="30px"
                  alt
                  style="left:30px;z-index:3;"
                />
                <span class="add" style="left:50px;z-index:4;">
                  <svg class="icon" aria-hidden="true">
                    <use xlink:href="#icon-renshu" />
                  </svg>
                </span>
              </div>
              <!-- 多人团剩n-1人 -->
              <div class="left" v-if="item.nums > 4 && item.remain_nums == item.nums - 1">
                <img
                  :src="item.user_head_list[0]"
                  width="30px"
                  height="30px"
                  alt
                  style="left:0;z-index:1;"
                />
                <span class="add" style="left:15px;z-index:2;">
                  <svg class="icon" aria-hidden="true">
                    <use xlink:href="#icon-renshu" />
                  </svg>
                </span>
                <span class="over" style="left:30px;z-index:3;">...</span>
                <span class="add" style="left:50px;z-index:4;">
                  <svg class="icon" aria-hidden="true">
                    <use xlink:href="#icon-renshu" />
                  </svg>
                </span>
              </div>
              <!-- 多人团剩小于n-1人 -->
              <div class="left" v-if="item.nums > 4 && item.remain_nums < item.nums - 1">
                <img
                  :src="item.user_head_list[0]"
                  width="30px"
                  height="30px"
                  alt
                  style="left:0;z-index:1;"
                />
                <img
                  :src="item.user_head_list[1]"
                  width="30px"
                  height="30px"
                  alt
                  style="left:15px;z-index:2;"
                />
                <span class="over" style="left:30px;z-index:3;">...</span>
                <span class="add" style="left:50px;z-index:4;">
                  <svg class="icon" aria-hidden="true">
                    <use xlink:href="#icon-renshu" />
                  </svg>
                </span>
              </div>
              <div class="mid">
                <div>还差{{item.remain_nums}}人成团</div>
                <div class="time">剩余{{remain_time[index].date}}</div>
              </div>
              <div class="right">
                <van-button
                  round
                  size="small"
                  type="danger"
                  disabled
                  v-if="couponInfo.groupbuy.my_open_ids.length>0 || couponInfo.groupbuy.user_remain_nums == 0"
                >去参团</van-button>
                <van-button round size="small" type="danger" @click="addgroup(item)" v-else>去参团</van-button>
              </div>
            </div>
          </div>
          <div class="groupbottom" v-if="couponInfo.groupbuy.my_open_ids.length>0">
            <div class="text">您正在参加该商品的拼团哦~</div>
            <van-button type="danger" size="small" round @click="togroupDetail">去看看</van-button>
          </div>
          <div class="groupbottom" v-else>
            <div class="text">开团/参团 - 邀请好友 - 满员发货/不满员退款</div>
            <van-button
              type="danger"
              size="small"
              round
              v-if="couponInfo.groupbuy.can_open_nums == 0"
              disabled
            >一键开团</van-button>
            <van-button type="danger" size="small" round @click="group" v-else>一键开团</van-button>
          </div>
        </div>
      </van-popup>
      <!-- 评论 -->
      <van-popup v-model="commentModel" position="bottom">
        <div class="audioList">
          <div class="title">
            <div class="action" @click="commentClose">
              <svg class="icon" aria-hidden="true">
                <use xlink:href="#icon-fold-line" />
              </svg>
            </div>
            <div>发表评论</div>
            <div class="punish" @click="punishComment">发布</div>
          </div>
          <!-- 音频列表 -->
          <div class="content">
            <textarea v-model="contentModel" placeholder="快来写评论吧!" @input="inputChange"></textarea>
            <div class="count">
              <span :class="{ active: contentLength > contentTotal }">{{ contentLength }}</span>
              /{{ contentTotal }}
            </div>
          </div>
        </div>
      </van-popup>
    </div>
    <EazyNav type="brand" ref="nav" :isShow="true"></EazyNav>
    <!--通用弹窗-->
    <PublicPopup></PublicPopup>
    <!--打开app对应页面-->
    <!--<openAppPage :name="'/album/index'"></openAppPage>-->
  </div>
</template>

<style src="@/style/scss/pages/album/index.scss" lang="scss"></style>
<style lang="scss">
#albumPage {
  .van-button {
    border-radius: 0;
  }
  [class*="van-hairline"]:after {
    border: none;
  }
  .coupon .van-cell__value {
    display: none;
  }
  .van-goods-action {
    .van-goods-action-mini-btn {
      border-color: #d2d2d2;
      border-width: 1px 0 0 0;
      border-style: solid;
    }
    .van-button--warning {
      background-color: #fff;
      color: $redLight;
      border-color: #d2d2d2;
      border-width: 1px 0 0 1px;
    }
  }
  & .infoContent {
    & .htmlContent{
      & a{
        text-decoration: underline;
        color: #01AAED;
      }
    }
  }
}
</style>

<script>
import miniAudio from "./../../components/miniAudio";
import audioList from "./../../pages/album/list";
// import easyNav from "./../../components/easyNav";
//  引入接口
import { ALBUM, ALBUM_DETAIL } from "../../apis/album.js";
import { GOODS_TICKET_GETS, TICKET_LINK } from "../../apis/coupon.js";
import {
  COLLECT_ADD,
  COLLECT_CANCEL,
  FOCUS_ADD,
  FOCUS_CANCEL,
  COMMENT,
  COMMENT_ADD,
  RECOMMEND
} from "../../apis/public.js";
import { setTimeout } from "timers";
import { truncate } from "fs";
export default {
  components: {
    miniAudio,
    audioList
  },
  data() {
    return {
      showBuyButton: true,
      isLogin: null,
      onsale: null,
      // 快速导航
      // navData: {
      //   fold: false,
      //   home: true,
      //   homeLink: "/brand/index",
      //   search: false,
      //   personal: true,
      //   personalLink: "/personal/index",
      // },
      /*
       * ----------------------------------介绍----------------------------------
       */
      // 基础信息
      baseData: {
        title: "",
        sub_title: "",
        pic: [],
        goods_type: null,
        collection_num: 0,
        collect_id: null,
        goods_id: null
      },
      // 所属媒体信息
      brandInfoData: {
        header_pic: "",
        name: "",
        fans: 0,
        is_followed: null
      },
      // 选项卡
      tabData: [
        {
          title: "介绍"
        },
        {
          title: "节目"
        },
        {
          title: "相似"
        }
      ],
      tabModel: 1,
      activeKey: 1,
      // 评论
      discussData: [],
      commentPage: 1,
      totalCount: "评论 (" + 0 + ")",
      // 发布评论
      commentModel: false,
      contentModel: "",
      contentTotal: 30,
      contentLength: 0,
      // 分页
      commentLoading: false,
      commentFinished: false,
      // 回复
      replyPage: [],
      answerData: [],
      // 存放回复评论comment_id
      commentId: null,
      // 存放发布按钮类型，comment为发布评论，reply为发布回复
      punishType: "comment",
      /*
       * ----------------------------------节目----------------------------------
       */
      showHistory: true,
      programList: [],
      programPage: 1,
      // 分页
      programLoading: false,
      programFinished: false,
      // 节目总数
      programTotalCount: 0,
      // 迷你音频当前节目信息
      myAudioData: {},
      // 存放当前播放音频key值
      activeGoodNo: null,
      // 存放当前播放器播放状态
      audioPlaying: false,
      // 排序
      rankType: 1, // 默认0倒序, 1正序
      // 记录节目播放进度
      progressList: [],
      /*
       * --------------------------------播放列表--------------------------------
       */
      // popupModel: false,
      // 试听数据，存放goods_no为1的数据
      preListen: [],
      // 存放全部音频
      allAudioData: [],
      // 存放不包含文章类型全部播放所有节目
      allProgramList: [],
      // 判断是否需要自动播放
      autoPlay: true,
      // 全部播放状态
      allPlayStatus: "play",
      /*
       * --------------------------------相似--------------------------------
       */
      recommendList: [],
      recommendPage: 1,
      // 分页
      recommendLoading: false,
      recommendFinished: false,
      // 存放相似状态
      simularStatus: [],
      // 优惠券信息
      couponInfo: null,
      couponList: [],
      couponModel: false,
      isReceived: false,
      requestState: true,
      groupModel: false,
      remain_time: [],
      // 判断是否第一次调取
      ifFirst:0,
    };
  },
  mounted() {
    this.baseData.goods_id = parseInt(this.$route.query.goods_id);
    // 当前页接口信息
    this.albumData();
    this.getCouponList();
  },
  updated() {
    if (this.baseData.single_activity_id) {
      $(".van-goods-action-big-btn .van-button__text").html(
        '<div style="line-height:1;font-size:16px;">限时促销价￥' +
          this.baseData.price +
          '</div><div style="line-height:1;font-size:12px;margin-top:5px;"><del style="color:#e1e1e1;">原价￥' +
          this.baseData.market_price +
          "</del> 购买专辑</div>"
      );
    }
    if (
      this.couponInfo.groupbuy &&
      Object.keys(this.couponInfo.groupbuy).length > 0
    ) {
      $(".van-goods-action-big-btn.van-button--warning .van-button__text").html(
        '<div style="line-height:1;font-size:15px;">￥' +
          this.baseData.price +
          '</div><div style="line-height:1;font-size:15px;margin-top:5px;"> 直接购买</div>'
      );
      $(".van-goods-action-big-btn.van-button--danger .van-button__text").html(
        '<div style="line-height:1;font-size:15px;">￥' +
          this.couponInfo.groupbuy.groupbuy_price +
          '</div><div style="line-height:1;font-size:15px;margin-top:5px;"> ' +
          this.couponInfo.groupbuy.groupbuy_num +
          "人拼团价</div>"
      );
    }
  },
  methods: {
    // 进入详情
    gotoDetail(item) {
      var _name;
      if (item.goods_type == 1 || item.goods_type == 2) {
        _name = "albumdetail";
      }
      if (item.goods_type == 6) {
        _name = "article";
      }
      this.$router.push({
        name: _name,
        query: {
          pid: this.baseData.goods_id,
          goods_id: item.goods_id,
          goods_no: item.goods_no
        }
      });
    },
    // --------------------------------专辑信息----------------------------------
    // 获取专辑接口信息
    async albumData() {
      var tStamp = this.$getTimeStamp();
      let data = {
        ad: parseInt(this.$route.query.ad) == 1 ? 1 : 0,
        timestamp: tStamp,
        goods_id: this.baseData.goods_id,
        version: "1.0"
      };
      data.sign = this.$getSign(data);
      let res = await ALBUM(data);
      if (res.hasOwnProperty("response_code")) {
        //专辑基础信息
        this.baseData = res.response_data.base;
        // 所属媒体信息
        this.brandInfoData = res.response_data.brand_info;
        // 登录状态
        this.isLogin = res.response_data.user_info.is_login;
        // title
        document.title = "节目详情-" + res.response_data.base.title;
        // 优惠券
        this.couponInfo = res.response_data.activity;
        if (
          this.couponInfo.groupbuy &&
          Object.keys(this.couponInfo.groupbuy).length > 0 &&
          this.couponInfo.groupbuy.open_list.length > 0
        ) {
          if (this.couponInfo.groupbuy.open_list.length > 2) {
            this.couponInfo.groupbuy.open_list = this.couponInfo.groupbuy.open_list.slice(
              0,
              2
            );
          }
          for (var i = 0; i < this.couponInfo.groupbuy.open_list.length; i++) {
            this.remain_time.push({
              time: this.couponInfo.groupbuy.open_list[i].remain_time,
              date: ""
            });
            this.$timeCountDown(this.remain_time[i]);
          }
        }
        // 获取页面分享信息
        // if (this.isWxLogin) this.wxShareData();
        // var _pageName = "goods/detail";
        // var _params = JSON.stringify({ goods_id: this.$route.query.goods_id });
        // if (this.isWxLogin) this.$getWxShareData(_pageName, _params);

        // 是否显示底部购买按钮
        this.showBuyButton = !(
          this.baseData.is_free == 0 &&
          this.baseData.is_payed == 0 &&
          this.baseData.sale_style == 1
        );
        this.onsale = 1;
      } else {
        if (res.hasOwnProperty("error_code") && res.error_code == 401) {
          // 上下架状态, 1=> 在架, 0=> 下架
          this.onsale = 0;
        }
        this.$toast(res.error_message);
      }
      // console.log('专辑基础信息:', res.response_data);
      // 读取localStorage音频缩略播放器数据
      this.getMiniAudioData();
    },
    // 获取收藏接口信息
    collectAction(__type, __collectId, __goodsId) {
      if (__collectId > 0) {
        this.collectData(__type, "cancel", __goodsId);
      } else {
        this.collectData(__type, "collect", __goodsId);
      }
    },
    async collectData(__type, __status, __goodsId) {
      var tStamp = this.$getTimeStamp();
      var data = {};
      var res;
      // 出错提示
      switch (__status) {
        case "collect":
          data = {
            timestamp: tStamp,
            type: this.baseData.goods_type,
            target: __goodsId,
            version: "1.0"
          };
          data.sign = this.$getSign(data);
          res = await COLLECT_ADD(data);
          if (res.hasOwnProperty("response_code")) {
            if (__type == "base") {
              this.baseData.collect_id = 1;
            } else {
              this.simularStatus[__type].is_collect = 1;
            }
          } else {
            this.$toast(res.error_message);
            if (res.hasOwnProperty("error_code") && res.error_code == 100) {
              this.$router.push({ name: "login", params: {} });
            }
          }
          this.baseData.collection_num++;
          // this.$toast("已收藏~");
          break;
        case "cancel":
          data = {
            timestamp: tStamp,
            goods_id: __goodsId,
            version: "1.0"
          };
          data.sign = this.$getSign(data);
          res = await COLLECT_CANCEL(data);
          if (res.hasOwnProperty("response_code")) {
            if (__type == "base") {
              this.baseData.collect_id = 0;
            } else {
              this.simularStatus[__type].is_collect = 0;
            }
            this.$toast("已取消收藏~");
          } else {
            this.$toast(res.error_message);
            if (res.hasOwnProperty("error_code") && res.error_code == 100) {
              this.$router.push({ name: "login", params: {} });
            }
          }
          this.baseData.collection_num--;
          break;
      }
    },
    // 获取关注接口信息
    async focusData(__type) {
      var tStamp = this.$getTimeStamp();
      var data = {};
      var res;
      switch (__type) {
        case "focus":
          data = {
            timestamp: tStamp,
            brand_id: this.baseData.brand_id,
            version: "1.0"
          };
          data.sign = this.$getSign(data);
          res = await FOCUS_ADD(data);
          if (res.hasOwnProperty("response_code")) {
            this.brandInfoData.is_followed = 1;
            this.brandInfoData.fans++;
          } else {
            this.$toast(res.error_message);
            if (res.hasOwnProperty("error_code") && res.error_code == 100) {
              this.$router.push({ name: "login", params: {} });
            }
          }
          // this.$toast('已关注~');
          break;
        case "cancel":
          data = {
            timestamp: tStamp,
            brand_id: this.baseData.brand_id,
            version: "1.0"
          };
          data.sign = this.$getSign(data);
          res = await FOCUS_CANCEL(data);
          if (res.hasOwnProperty("response_code")) {
            this.brandInfoData.is_followed = 0;
            this.brandInfoData.fans--;
            this.$toast("已取消关注~");
          } else {
            this.$toast(res.error_message);
            if (res.hasOwnProperty("error_code") && res.error_code == 100) {
              this.$router.push({ name: "login", params: {} });
            }
          }
          break;
      }
    },
    // 关注
    focusAction() {
      if (this.brandInfoData.is_followed > 0) {
        this.focusData("cancel");
      } else {
        this.focusData("focus");
      }
    },
    // tab切换
    tabChange(index, title) {
      this.activeKey = index;
    },
    // 拼团
    openGroup() {
      this.groupModel = true;
    },
    // 参团
    addgroup(item) {
      this.$router.push({
        name: "groupdetail",
        query: {
          open_id: item.open_id
        }
      });
    },
    group() {
      if (this.$refs.nav.is_Login) {
        this.$router.push({
          name: "payaccount",
          query: {
            goods_id: this.baseData.goods_id,
            groupbuy_id: this.couponInfo.groupbuy.id
          }
        });
      } else {
        this.$router.push({ name: "login" });
      }
    },
    togroupDetail() {
      this.$router.push({
        name: "groupdetail",
        query: {
          open_id: this.couponInfo.groupbuy.my_open_ids[0]
        }
      });
    },
    // ----------------------------------评论------------------------------------
    commentLoad() {
      this.commentData();
    },
    async commentData() {
      var tStamp = this.$getTimeStamp();
      let data = {
        timestamp: tStamp,
        page: this.commentPage,
        goods_id: parseInt(this.$route.query.goods_id),
        page_size: 10,
        version: "1.0"
      };
      data.sign = this.$getSign(data);
      let res = await COMMENT(data);
      if (res.hasOwnProperty("response_code")) {
        // 异步更新数据
        var result = res.response_data.result;
        setTimeout(() => {
          for (let i = 0; i < res.response_data.result.length; i++) {
            this.discussData.push(result[i]);
            this.answerData.push(result[i].reply_list);
            this.replyPage.push(1);
            // console.log('评论：', result[i]);
          }
          // 加载状态结束
          this.commentLoading = false;
          this.commentPage++;
          // 数据全部加载完成
          if (this.commentPage > res.response_data.total_page) {
            this.commentFinished = true;
            this.commentPage = 1;
          }
        }, 600);
        // 设置总评论数
        this.totalCount = "评论 (" + res.response_data.total_count + ")";
        // console.log("当前页数组：", this.replyPage);
        // console.log("评论列表：", result);
      } else {
        this.$toast(res.error_message);
      }
    },
    // 回复
    async replyData(comment_id, key) {
      var tStamp = this.$getTimeStamp();
      let data = {
        timestamp: tStamp,
        comment_pid: comment_id,
        page: this.replyPage[key],
        page_size: 10,
        version: "1.0"
      };
      data.sign = this.$getSign(data);
      let res = await COMMENT(data);
      if (res.hasOwnProperty("response_code")) {
        // 异步更新数据
        var result = res.response_data.result;
        for (let i = 0; i < result.length; i++) {
          this.answerData[key].push(result[i]);
        }
        if (this.replyPage[key] > res.response_data.total_page) {
          this.replyPage[key] = res.response_data.total_page + 1;
        } else {
          this.replyPage[key]++;
        }
      } else {
        this.$toast(res.error_message);
      }
    },
    // 回复展开更多
    pageChange(comment_id, key) {
      this.replyData(comment_id, key);
      // console.log("当前页数组：", this.replyPage, 'key:', key);
    },
    // 关闭评论弹窗
    commentClose() {
      this.commentModel = false;
    },
    /*
     * __type = 'comment'; 新增评论
     * __type = 'reply';   新增回复
     */
    async addComment(__type) {
      var tStamp = this.$getTimeStamp();
      var data = {};
      switch (__type) {
        case "comment":
          data = {
            timestamp: tStamp,
            goods_id: this.baseData.goods_id,
            content: this.contentModel,
            version: "1.0"
          };
          break;
        case "reply":
          data = {
            timestamp: tStamp,
            goods_id: this.baseData.goods_id,
            comment_pid: this.commentId,
            content: this.contentModel,
            version: "1.0"
          };
          break;
        default:
          break;
      }
      data.sign = this.$getSign(data);
      let res = await COMMENT_ADD(data);
      if (res.hasOwnProperty("response_code")) {
        this.commentPage = 1;
        // 本地存储最新的数据，展示
        this.answerData = [];
        this.discussData = [];
        this.replyPage = [];
        this.contentModel = "";
        this.commentData();
      } else {
        this.$toast(res.error_message);
      }
    },
    punishComment() {
      if (this.contentLength > this.contentTotal) {
        this.$toast("你发布的字数超出，请修改后再发布!");
        return;
      }
      if (this.contentLength == 0) {
        this.$toast("请输入你要发布的内容!");
        return;
      }
      this.commentModel = false;
      // this.discussData = [];
      this.addComment(this.punishType);
    },
    /*
     * __type: 'comment'; 评论，comment_id: null;
     * __type: 'reply'; 回复评论，comment_id: 必填;
     */
    openAnswer(__type, comment_id) {
      // 未登录跳转至登录页
      if (this.isLogin == 0) {
        this.$router.push({ name: "login", params: {} });
        this.$toast("用户未登录!");
        return;
      }
      this.punishType = __type;
      if (__type == "reply") this.commentId = comment_id;
      this.commentModel = true;
    },
    // 编辑评论触发
    inputChange() {
      this.contentLength = this.contentModel.length;
    },
    // ----------------------------------节目------------------------------------
    // load
    programLoad() {
      // console.log("load");
      this.programData("");
      // 获取试听节目
      if(this.ifFirst == 0){
        this.preListenData();
      }
    },
    // 排序
    rankAction() {
      this.rankType = this.rankType == 1 ? 0 : 1;
      this.allPlayStatus = "play";
      // 实时刷新先置空
      this.programFinished = false;
      this.programLoading = true;
      this.programPage = 1;
      // console.log(666, this.programPage);
      var _type = "rank";
      this.programData(_type);
    },
    // 获取试听节目
    async preListenData() {
      var tStamp = this.$getTimeStamp();
      let data = {
        timestamp: tStamp,
        goods_id: this.baseData.goods_id,
        goods_no: this.rankType,
        page: 1,
        page_size: 10000000,
        version: "1.0"
      };
      data.sign = this.$getSign(data);
      let res = await ALBUM_DETAIL(data);
      if (res.hasOwnProperty("response_code")) {
        this.ifFirst ++;
        // 异步更新数据
        var result = res.response_data.result;
        for (let i = 0; i < res.response_data.result.length; i++) {
          // 存放试听数据,只取第一条
          if (
            result[i].is_free &&
            result[i].goods_type != 6 &&
            this.preListen.length == 0
          ) {
            this.preListen = [];
            this.preListen.push(result[i]);
          }
        }
      } else {
        this.$toast(res.error_message);
      }
    },
    // 获取节目列表
    async programData(_type) {
      // console.log(this.programPage);
      var tStamp = this.$getTimeStamp();
      let data = {
        timestamp: tStamp,
        goods_id: this.baseData.goods_id,
        goods_no: this.rankType,
        page: this.programPage,
        page_size: 10,
        version: "1.0"
      };
      data.sign = this.$getSign(data);
      let res = await ALBUM_DETAIL(data);
      if (res.hasOwnProperty("response_code")) {
        if (_type == "rank") this.programList = [];
        // 异步更新数据
        var result = res.response_data.result;
        setTimeout(() => {
          // this.programList = [];
          for (let i = 0; i < res.response_data.result.length; i++) {
            this.programList.push(result[i]);
            // 存放试听数据,只取第一条
            if (
              result[i].is_free &&
              result[i].goods_type != 6 &&
              this.preListen.length == 0
            ) {
              this.preListen = [];
              this.preListen.push(result[i]);
            }
          }
          // localStorage:audioProgress存放节目播放进度,根据pid创建数组，并存放至localStorage
          this.progressListData();
          // 设置迷你缩略音频播放信息
          this.getMiniAudioData();
          // 加载状态结束
          this.programLoading = false;
          this.programPage++;
          // 数据全部加载完成
          if (this.programPage > res.response_data.total_page) {
            this.programFinished = true;
          }
        }, 600);
        // 设置总节目数
        this.programTotalCount = res.response_data.total_count;
      } else {
        this.$toast(res.error_message);
      }
    },
    // 读取localStorage：miniAudio音频缩略播放器数据
    getMiniAudioData() {
      // 设置迷你音频信息
      var info = JSON.parse(localStorage.getItem("miniAudio"));
      // 解决子组件数据实时刷新问题
      if (this.$refs.control)
        this.$refs.control.audioData.type = !this.audioPlaying;
      if (info != null && info.length != 0) {
        // 当前goods_id与localStorage一致时,关联播放列表当前播放状态
        for (let i = 0; i < this.programList.length; i++) {
          var list = this.programList[i];
          if (list.goods_id == info[8]) {
            this.activeGoodNo = info[0];
          }
        }
        // 将当前音频播放信息存放到localStorage: miniAudio
        this.miniAudioData(info);
      }
      // 设置缩放音频当前播放进度
      setTimeout(() => {
        var audio = document.getElementById("myMiniAudio");
        // currentTime关联slider进度
        if (info != null && info[5] != null && info[5] != "") {
          if (this.$refs.control)
            this.$refs.control.audioData.sliderValue =
              (info[5] / audio.duration) * 100;
        }
        if (info != null && info[4] != null && info[4] != "") {
          if (this.$refs.control) this.$refs.control.audioSliderChange();
        }
      }, 600);
      // console.log("localStorage迷你音频信息:", info, "当前goodsNo:", this.activeGoodNo, "当前pid:", this.baseData.goods_id, "当前goodsId:", this.myAudioData.goodsId, "当前currentTime：", this.myAudioData.currentTime);
    },
    // 将当前音频播放信息存放到localStorage: miniAudio
    miniAudioData(info) {
      // console.log(1111111)
      /*
       * __goodsNo节目编号
       * __pid当前节目对应专辑id，单个节目时pid为0
       * __pic专辑封面
       * __src音频地址
       * __duration音频时长，单位s
       * __currentTime音频当前播放位置，单位s
       * __program节目标题
       * __album专辑标题
       * __goodsId商品id
       * __albumPic专辑图片，无专辑为null
       */
      if (info != null && info.length > 0) {
        let __goodsNo = info[0];
        let __pid = info[1];
        let __pic = info[2];
        let __src = info[3];
        let __duration = info[4];
        let __currentTime = info[5];
        let __program = info[6];
        let __album = info[7];
        let __goodsId = info[8];
        let __albumPic = info[9];
        // 设置音频信息
        this.$set(this.myAudioData, "goodsNo", __goodsNo);
        this.$set(this.myAudioData, "pid", __pid);
        this.$set(this.myAudioData, "pic", __pic);
        this.$set(this.myAudioData, "src", __src);
        this.$set(this.myAudioData, "duration", __duration);
        this.$set(this.myAudioData, "currentTime", __currentTime);
        this.$set(this.myAudioData, "program", __program);
        this.$set(this.myAudioData, "album", __album);
        this.$set(this.myAudioData, "goodsId", __goodsId);
        this.$set(this.myAudioData, "albumPic", __albumPic);

        // localStorage存储
        localStorage.setItem("miniAudio", JSON.stringify(info));
        // 解决父页面子组件实时刷新问题
        setTimeout(() => {
          if (this.$refs.control) {
            this.$refs.control.audioData.pic = __pic;
            this.$refs.control.audioData.src = __src;
            this.$refs.control.audioData.currentTime = __currentTime;
            this.$refs.control.audioData.duration = __duration;
            this.$refs.control.audioData.program = __program;
            this.$refs.control.audioData.album = __album;
            this.$refs.control.audioData.albumPic = __albumPic;
          }
        }, 600);
        // if (info[3] == null) {
        //   $("#miniAudio").css("display", "none");
        // } else {
        //   $("#miniAudio").css("display", "block");
        // }
      }
    },
    // localStorage:audioProgress存放节目播放进度
    progressListData() {
      /*
       * __goodsId节目id
       * __goodsNo节目编号
       * __progress节目当前播放进度
       * __duration节目时长，单位s
       * __pid专辑id，单个节目pid默认为0
       */
      var result = JSON.parse(localStorage.getItem("audioProgress"));
      // 临时存放节目进度
      this.progressList = [];
      for (let i = 0; i < this.programList.length; i++) {
        this.progressList.push(this.programList[i]);
        if (result != null && result.length > 0) {
          for (let j = 0; j < result.length; j++) {
            // 当节目播放进度存在localStorage时,显示已播放进度
            if (
              result[j].pid == this.baseData.goods_id &&
              result[j].goods_id == this.programList[i].goods_id
            ) {
              this.$set(
                this.progressList[i],
                "progressHistory",
                result[j].progress
              );
            }
          }
        }
      }
    },
    // 将当前专辑节目列表播放进度信息存放到localStorage
    audioProgressData(result) {
      /*
       * __goodsId专辑id
       * __goodsNo节目编号
       * __progress节目当前播放进度
       * __duration节目时长，单位s
       * __pid专辑id，单个节目pid默认为0
       */
      // localStorage存储
      localStorage.setItem("audioProgress", JSON.stringify(result));
      this.progressListData();
      this.$refs.controlList.progressListData();
    },
    // 播放记录
    historyAction() {
      this.showHistory = false;
    },
    // 节目列表播放/暂停音频
    audioAction(item) {
      // 视频跳转到节目详情页
      // if (item.goods_type == 2) {
      //   this.$router.push({
      //     name: "albumdetail",
      //     query: {
      //       pid: this.baseData.goods_id,
      //       goods_id: item.goods_id,
      //       goods_no: item.goods_no
      //     }
      //   });
      //   return;
      // }
      // console.log(item);
      // 未支付
      if (item.goods_id != null && item.is_payed == 0 && item.is_free == 0) {
        // var _goodsId = null;
        if (this.baseData.sale_style == 1) {
          this.$router.push({
          name: "payaccount",
            query: { goods_id: this.baseData.goods_id }
          });
        } else {
          this.$router.push({
            name: "payaccount",
            query: { goods_id: this.baseData.goods_id, pid: item.goods_id }
          });
        }

        console.log('第二次跳转购买')
        return;
      }
      $("#miniAudio").css("display", "block");
      let __goodsNo = item.goods_no;
      let __pid = this.baseData.goods_id ? this.baseData.goods_id : 0;
      let __pic = item.pic;
      let __src = item.file_path;
      let __duration = item.duration;
      // 获取当前节目播放进度
      // ??????????????????????
      let __currentTime = this.getAudioProgress(item);
      let __program = item.title;
      let __album = this.baseData.title;
      let __goodsId = item.goods_id;
      let __albumPic = this.baseData.pic[0];
      // console.log( this.baseData)
      // 判断是否点击当前或者第一次点击
      if (this.activeGoodNo == __goodsNo || this.activeGoodNo == null) {
        this.audioPlaying = !this.audioPlaying;
      } else {
        this.audioPlaying = true;
      }
      // 父页面关联子组件
      setTimeout(() => {
        if (this.audioPlaying) {
          this.$refs.control.playAudio(__currentTime);
          // 设置全部播放状态
          this.allPlayStatus = "pause";
        } else {
          this.$refs.control.pauseAudio();
          this.allPlayStatus = "continue";
        }
      }, 600);
      // console.log(__currentTime)
      // 管理子组件播放状态
      this.activeGoodNo = __goodsNo;
      // 解决子组件数据实时刷新问题
      this.$refs.control.audioData.type = !this.audioPlaying;
      // 将当前音频播放信息存放到localStorage: miniAudio
      var info = [
        __goodsNo,
        __pid,
        __pic,
        __src,
        __duration,
        __currentTime,
        __program,
        __album,
        __goodsId,
        __albumPic
      ];
      this.miniAudioData(info);
    },
    // 获取当前节目播放进度
    getAudioProgress(item) {
      var pid = this.baseData.goods_id;
      var goods_no = item.goods_no;
      var goods_id = item.goods_id;
      var result = JSON.parse(localStorage.getItem("audioProgress"));
      // 默认从0播放,如果localStorage有播放进度记录则从记录处播放
      var __currentTime = 0;
      if (result != null && result.length > 0) {
        // 遍历localStorage中记录进度的数组，获取当前节目当前进度
        for (let i = 0; i < result.length; i++) {
          if (goods_id == result[i].goods_id && pid == result[i].pid) {
            __currentTime = result[i].progress;
          }
        }
      }
      // 如果当前节目有播放记录，跳到当前记录位置继续播放
      return __currentTime;
    },
    // 点击播放，子组件关联父页面 - 切换miniAudio组件播放状态
    typeAction(__type) {
      /*
       * __type == true; 播放
       * __type == false; 暂停
       */
      // 关联节目列表播放状态
      this.myAudioData.type = __type;
      this.audioPlaying = !__type;
    },
    // --------------------------------播放列表----------------------------------
    audioListShow(__type) {
      this.$refs.controlList.popupModel = true;
      // 关联播放列表
      this.$refs.controlList.goodsNo = this.activeGoodNo;
    },
    gotoPlayer(queryData) {
      this.$router.push({ name: "player", query: { isLogin: this.isLogin } });
    },
    // 点击试听
    preListenAction() {
      if (this.preListen != null && this.preListen.length > 0) {
        this.$router.push({
          name: "albumdetail",
          query: {
            pid: this.baseData.goods_id,
            goods_id: this.preListen[0].goods_id,
            goods_no: this.preListen[0].goods_no
          }
        });
      } else {
        this.$toast("无试听节目~");
      }
    },
    // 当前节目播放结束，获取当前播放节目的专辑下所有节目（不分页）
    getAllProgramData(info) {
      this.allProgramData(info, "end");
    },
    async allProgramData(info, actionType) {
      var tStamp = this.$getTimeStamp();
      let data = {
        timestamp: tStamp,
        goods_id: this.baseData.goods_id,
        goods_no: this.rankType,
        page_size: 1000000000000000,
        version: "1.0"
      };
      data.sign = this.$getSign(data);
      let res = await ALBUM_DETAIL(data);
      // 存储当前节目的下一项
      var next;
      this.allProgramList = [];
      if (res.hasOwnProperty("response_code")) {
        var type1 = 0;
        var type2 = 0;
        var type3 = 0;
        // 异步更新数据
        var result = res.response_data.result;
        for (let i = 0; i < res.response_data.result.length; i++) {
          var type = result[i].goods_type;
          if (type == 1) type1 = 1;
          if (type == 2) type2 = 1;
          if (type == 6) type3 = 1;
          // 不包含文章类型
          // if (result[i].goods_type != 6) {
          this.allProgramList.push(result[i]);
          // }
          if (
            info != null &&
            info.length > 0 &&
            result[i].goods_no == info[0]
          ) {
            next = i + 1;
          }
        }
        // 专辑is_payed:0未支付；1已支付，is_freeL:0不免费，1免费，未支付不能自动播放
        if (
          eval(type1 + type2 + type3) > 1 ||
          (this.baseData.is_free == 0 &&
            this.baseData.is_payed == 0 &&
            this.baseData.sale_style == 1)
        ) {
          this.autoPlay = false;
        } else {
          this.autoPlay = true;
        }
        var count = this.allProgramList.length;
        next = next > count - 1 ? 0 : next;
        // 当点击全部播放，从第一条开始播放
        if (actionType == "all") next = 0;
        // 当收费方式非专辑收费为单个节目收费时，跳转到需要收费的单个节目的支付页面
        if (
          this.allProgramList[next].is_payed == 0 &&
          this.allProgramList[next].is_free == 0
        ) {
          this.$router.push({
            name: "payaccount",
            query: { pid: parseInt(this.allProgramList[next].goods_id),goods_id:this.baseData.goods_id }
          });
          console.log('第一次跳转购买')
          return;
        }
        // 当第一条是视频或者是文章时，跳转到对应详情
        if (this.allProgramList[next].goods_type == 6) {
          this.$router.push({
            name: "article",
            query: {
              pid: parseInt(this.$route.query.goods_id),
              goods_id: parseInt(this.allProgramList[next].goods_id)
            }
          });
          return;
        }
        if (this.allProgramList[next].goods_type == 2) {
          this.$router.push({
            name: "albumdetail",
            query: {
              pid: parseInt(this.$route.query.goods_id),
              goods_id: parseInt(this.allProgramList[next].goods_id)
            }
          });
          return;
        }
      } else {
        this.$toast(res.error_message);
        return;
      }
      this.allPlayStatus = "pause";
      if (this.autoPlay) {
        // 单一类型，自动播放
        this.updateLocalStorage(this.allProgramList[next]);
        // console.log("当前播放的下一项：", this.allProgramList[next]);
        // console.log("单一类型，自动播放");
      } else {
        this.$refs.control.pauseAudio();
        this.allPlayStatus = "play";
        // 含多种类型，不自动播放
        this.$toast("含多种类型或者专辑未支付，不自动播放");
      }
    },
    // 更新localStorage数据
    updateLocalStorage(item) {
      var info = JSON.parse(localStorage.getItem("miniAudio"));
      if (info == null) info = [];
      info[0] = item.goods_no;
      info[1] = this.baseData.goods_id;
      info[2] = item.pic;
      info[3] = item.file_path;
      info[4] = item.duration;
      info[5] = 0;
      info[6] = item.title;
      info[7] = this.baseData.title;
      info[8] = item.goods_id;
      info[9] = this.baseData.pic[0];
      this.activeGoodNo = info[0];
      localStorage.setItem("miniAudio", JSON.stringify(info));
      // 更新播放器当前播放音频
      this.miniAudioData(info);
      setTimeout(() => {
        this.$refs.control.playAudio(0);
      }, 600);
    },
    // 全部播放
    allAction() {
      if (this.baseData.is_free == 0 && this.baseData.is_payed == 0) {
        this.$toast("专辑收费~");
        return;
      }
      // 全部播放
      if (this.allPlayStatus == "play") {
        var info = JSON.parse(localStorage.getItem("miniAudio"));
        // 从第一条开始播放，是否自动播放规则同上
        this.allProgramData(info, "all");
      }
      // 暂停播放
      else if (this.allPlayStatus == "pause") {
        this.allPlayStatus = "continue";
        this.$refs.control.pauseAudio();
      }
      // 继续播放
      else {
        this.allPlayStatus = "pause";
        this.$refs.control.playAudio(null);
      }
      $("#miniAudio").css("display", "block");
    },
    // 购买
    buyAction(goodsId) {
      if (this.$refs.nav.is_Login) {
        if (goodsId != null)
          this.$router.push({
            name: "payaccount",
            query: { goods_id: goodsId }
          });
      } else {
        this.$router.push({ name: "login" });
      }
    },
    // --------------------------------相似----------------------------------
    // load
    recommendLoad() {
      this.recommendData();
    },
    async recommendData() {
      var tStamp = this.$getTimeStamp();
      let data = {
        timestamp: tStamp,
        goods_id: this.baseData.goods_id,
        page: this.recommendPage,
        page_size: 10,
        version: "1.0"
      };
      data.sign = this.$getSign(data);
      let res = await RECOMMEND(data);
      console.log(666, res);
      if (res.hasOwnProperty("response_code")) {
        // 异步更新数据
        var result = res.response_data.result;
        setTimeout(() => {
          for (let i = 0; i < res.response_data.result.length; i++) {
            this.recommendList.push(result[i]);
            // 存放相似收藏状态/临时数据
            this.simularStatus.push(result[i]);
          }
          // 加载状态结束
          this.recommendLoading = false;
          this.recommendPage++;
          // 数据全部加载完成
          if (this.recommendPage > res.response_data.total_page) {
            this.recommendFinished = true;
            this.recommendPage = 1;
          }
        }, 600);
      } else {
        this.$toast(res.error_message);
      }
    },
    // 相似
    gotoLink(goodsId) {
      this.$router.push({
        name: "album",
        query: { goods_id: goodsId }
      });
      window.location.reload();
    },
    // 优惠券
    showCoupon() {
      this.couponModel = true;
    },
    closePopup() {
      this.couponModel = false;
    },
    async getCouponList() {
      var tStamp = this.$getTimeStamp();
      let data = {
        timestamp: tStamp,
        goods_id: this.baseData.goods_id,
        version: "1.0"
      };
      data.sign = this.$getSign(data);
      let res = await GOODS_TICKET_GETS(data);
      if (res.hasOwnProperty("response_code")) {
        // console.log(res);
        this.couponList = res.response_data;
        for (var i = 0; i < this.couponList.length; i++) {
          if (this.couponList[i].state == 3) {
            this.isReceived = true;
          }
        }
      } else {
        this.$toast(res.error_message);
      }
    },
    // 领取优惠券
    receive(item, index) {
      if (this.isLogin == 0) {
        this.$router.push({ name: "login", params: {} });
        this.$toast("用户未登录!");
      } else {
        this.ticketLink(item.ticket_id,index);
      }
    },
    async ticketLink(ticket_id,index) {
      this.requestState = false;
      var tStamp = this.$getTimeStamp();
      let data = {
        timestamp: tStamp,
        version: "1.0",
        ticket_id: ticket_id
      };
      data.sign = this.$getSign(data);
      let res = await TICKET_LINK(data);
      if (res.hasOwnProperty("response_code")) {
        // console.log(res);
        this.$toast("领取成功！");
        this.requestState = true;
        this.couponList = this.couponList.map((value, key) => {
          if (key == index) {
            value.state = 3;
            value.use_stime = res.response_data.use_stime;
            value.use_etime = res.response_data.use_etime;
          }
          return value;
        });
      } else {
        this.$toast(res.error_message);
        this.requestState = true;
      }
    },
    toResult(item, index) {
      sessionStorage.setItem('saveSearchContent',"")
      this.$router.push({
        name: "couponresult",
        query: {
          ticket_id: item.ticket_id
        }
      });
    }
  }
};
</script>
